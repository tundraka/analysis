---
title: "Bank statement analysis"
output: 
  html_document:
    keep_md: true
---

```{r initialize, echo=F}
timePeriod <- '201510'
setwd('~/Documents/code/analysis')
source('bank/transactions.R')

library(ggplot2)
library(xtable)
```

## Intro

This analysis is performed for the period: `r timePeriod`

## Sales transactions
This transactions are what we spent in the CCs.

```{r salestransactions,echo=F}
sales <- merge(transactions[type=='sale',
               .(description, amount=amount*-1, itemid, date, day=weekdays(date))
               ], items[,.(itemid, category, name)], by='itemid')
```

## Unknown transactions
The following are unknown transactions. This is a summary of transactions that
weren't classified and weren't part of this summary.

```{r unknowntxtable, echo=F, results='asis'}
unkTx <- sales[itemid=='UNK', .(description, amount)]
if (nrow(unkTx) > 0) {
    xt <- xtable(unkTx)
    print(xt, type='html', include.rownames=F)
} else {
    print('none')
}
```

#### Summary

```{r salestx, echo=F, results='asis'}
xt <- xtable(sales[, .(tot=sum(amount)), .(category)][order(-tot)])
print(xt, type='html', include.rownames=F)
```

### Groceries
Here we are listing the groceries transactions, the visits column indicates how
many times we went to that store, the column totvisit is just an average of the
total by visits.

```{r groceriesxt,echo=F, results='asis'}
summaryReport <- function(cat) {
    summary <- sales[category==cat, .(tot=sum(amount), visits=.N),
                     .(name)][,.(name, tot, visits,
                                 totpvisit=round(tot/visits, digits=2))][
                     order(-tot, visits)]
    xt <- xtable(summary)
    print(xt, type='html', include.rownames=F)
}

s('groceries')
```

### Restaurants

```{r restxt,echo=F, results='asis'}
summaryReport('restaurant')
```

### Shopping

```{r shoppingxt,echo=F, results='asis'}
summaryReport('shopping')
```

### Babies

```{r babiesxt,echo=F, results='asis'}
summaryReport('babies')
```

### Car

```{r carsxt,echo=F, results='asis'}
summaryReport('car')
```

### Other

```{r otherxt,echo=F, results='asis'}
summaryReport('other')
```

## Other transactions

### Utilities

```{r utilitiesxt,echo=F, results='asis'}
xt <- xtable(transactions[category=='utilities',
             .(name=ifelse(name=='Unknown', description, name), amount=-1*amount)])
print(xt, type='html', include.rownames=F)
```

### Returns
```{r returnsxt, echo=F, results='asis'}
xt <- xtable(transactions[type=='return',
             .(name=ifelse(name=='Unknown', description, name), amount)])
print(xt, type='html', include.rownames=F)
```

### Payments
```{r paymentsxt, echo=F, results='asis'}
xt <- xtable(transactions[type=='payment',
             .(name=ifelse(name=='Unknown', description, name), amount, account)])
print(xt, type='html', include.rownames=F)
```

### Credits
```{r creditsxt, echo=F, results='asis'}
xt <- xtable(transactions[type=='credit',
             .(name=ifelse(name=='Unknown', description, name) , amount)])
print(xt, type='html', include.rownames=F)
```

### Withdraw
```{r withdrawxt, echo=F, results='asis'}
xt <- xtable(transactions[category=='withdraw',
             .(cdate=as.character(date), name=ifelse(name=='Unknown', description, name)
               , amount=-1*amount)][order(cdate)])
print(xt, type='html', include.rownames=F)
```


### Recurring payments
```{r recurringxt, echo=F, results='asis'}
xt <- xtable(transactions[category=='recurring',
             .(name=ifelse(name=='Unknown', description, name), amount=-1*amount)])
print(xt, type='html', include.rownames=F)
```

transactions[type %in% c('check', 'debit') && category != 'saving',
            .(total=sum(amount))]
transactions[type=='credit', .(total=sum(amount))]
transactions[category=='recurring', .(total=sum(amount))]
# recurring minus dual income extras
transactions[category=='recurring' & !(itemid %in% c('AF', 'PB')), .(total=sum(amount))]
